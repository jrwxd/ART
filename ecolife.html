```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Ecosystem Simulation with DE Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif; display: flex; flex-direction: column;
            align-items: center; justify-content: flex-start; min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            margin: 0; padding: 1rem; color: #333;
        }
        .container {
            background-color: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px);
            padding: 1.5rem; border-radius: 1rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1), 0 15px 20px rgba(0,0,0,0.05);
            width: 100%; max-width: 1400px; 
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .canvas-container { 
            margin-bottom: 1rem; 
            background: white;
            border-radius: 0.75rem;
            padding: 0.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .canvas-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        canvas {
            display: block; background: linear-gradient(145deg, #f8fafc, #e2e8f0);
            border-radius: 0.5rem; width: 100%; cursor: default;
            border: 1px solid rgba(0,0,0,0.05);
        }
        #ecosystemCanvas { height: 300px; }
        #atmosphereCanvas { height: 240px; } 
        #nitrogenCanvas { height: 200px; }
        #temperatureCanvas { height: 200px; }
        #pieCanvas { height: 240px; }

        .controls, .stats-container {
            margin-top: 1rem; display: flex; flex-wrap: wrap;
            gap: 0.75rem; justify-content: center;
        }
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: 0.5rem; justify-content: center; width: 100%;
        }
        .controls button, .stats-grid div {
            padding: 0.75rem 1rem; border-radius: 0.75rem; font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            font-size: 0.875rem; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .controls button {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white; border: none; cursor: pointer;
            transform: translateY(0);
        }
        .controls button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }
        .controls button:active { transform: translateY(0); }
        .controls button.secondary { 
            background: linear-gradient(135deg, #6b7280, #374151);
        }
        .controls button.secondary:hover { 
            box-shadow: 0 8px 25px rgba(107, 114, 128, 0.4);
        }
        .controls button:disabled {
            opacity: 0.6; cursor: not-allowed;
            transform: translateY(0) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }
        .stats-grid div {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            color: #1f2937; text-align: center; border: 1px solid rgba(0,0,0,0.05);
        }
        .message-box {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: linear-gradient(135deg, #10b981, #059669);
            color: white; padding: 1rem 1.5rem; border-radius: 0.75rem; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1000; display: none; font-size: 0.9rem; font-weight: 600;
            backdrop-filter: blur(10px);
        }
        .message-box.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        h1 {
            font-size: 2rem; font-weight: 700; margin-bottom: 1rem; 
            text-align: center; 
            background: linear-gradient(135deg, #1e3a8a, #3730a3);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .legend {
            display: flex; justify-content: center; flex-wrap: wrap;
            gap: 1rem; margin-top: 0.5rem; margin-bottom: 0.75rem;
            font-size: 0.8rem; font-weight: 600;
        }
        .legend span { 
            display: flex; align-items: center; 
            background: rgba(255,255,255,0.7);
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .legend span::before {
            content: ''; width: 12px; height: 12px; 
            border-radius: 3px; margin-right: 0.5rem; display: inline-block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .legend .plant::before { background: linear-gradient(135deg, #4ade80, #22c55e); }
        .legend .herbivore::before { background: linear-gradient(135deg, #c084fc, #a855f7); }
        .legend .carnivore::before { background: linear-gradient(135deg, #fb923c, #f97316); }
        .legend .co2::before { background: linear-gradient(135deg, #71717a, #52525b); } 
        .legend .o2::before { background: linear-gradient(135deg, #60a5fa, #3b82f6); }  
        .legend .n2::before { background: linear-gradient(135deg, #a78bfa, #8b5cf6); }  
        .legend .an::before { background: linear-gradient(135deg, #facc15, #eab308); }  
        .legend .temp::before { background: linear-gradient(135deg, #ef4444, #dc2626); }

        .parameter-tray, .de-editor-tray {
            background: rgba(249, 250, 251, 0.95); 
            border: 1px solid rgba(229, 231, 235, 0.5);
            border-radius: 0.75rem; padding: 0; margin-top: 1rem;
            max-height: 0; overflow: hidden;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .parameter-tray.open { max-height: 2500px; padding: 1.5rem; }
        .de-editor-tray.open { max-height: 1000px; padding: 1.5rem; }
        .parameter-tray h2, .de-editor-tray h2 {
            font-size: 1.25rem; font-weight: 700; 
            margin-bottom: 1rem; color: #374151;
            border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;
        }
        .param-section, .de-section { margin-bottom: 1rem; }
        .param-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }
        .param-item { display: flex; flex-direction: column; }
        .param-item label {
            font-size: 0.875rem; color: #4b5563; margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .param-item input[type="number"] {
            padding: 0.75rem; border: 2px solid #d1d5db;
            border-radius: 0.5rem; font-size: 0.875rem; width: 100%;
            transition: all 0.3s ease;
            background: white;
        }
        .param-item input[type="number"]:focus {
            outline: none; border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }
        #toggleParamsButton { 
            background: linear-gradient(135deg, #10b981, #059669); 
        }
        #toggleParamsButton:hover { 
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }
        #toggleDEButton { 
            background: linear-gradient(135deg, #8b5cf6, #7c3aed); 
        }
        #toggleDEButton:hover { 
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }

        .de-equation {
            margin-bottom: 1.5rem; padding: 1.5rem; 
            border: 2px solid #d1d5db;
            border-radius: 0.75rem; 
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .de-equation label {
            display: block; font-weight: 700; margin-bottom: 0.75rem;
            color: #374151; font-size: 1rem;
        }
        .de-equation textarea {
            width: 100%; height: 100px; padding: 0.75rem;
            border: 2px solid #d1d5db; border-radius: 0.5rem;
            font-family: 'JetBrains Mono', 'Courier New', monospace; 
            font-size: 0.875rem; resize: vertical;
            transition: all 0.3s ease; background: white;
        }
        .de-equation textarea:focus {
            outline: none; border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .de-help {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border: 2px solid #bfdbfe; border-radius: 0.75rem; 
            padding: 1rem; margin-bottom: 1.5rem;
            font-size: 0.875rem; color: #1e40af;
        }
        .de-help h3 {
            font-weight: 700; margin-bottom: 0.75rem; font-size: 1rem;
        }
        .de-help code {
            background: rgba(219, 234, 254, 0.7); 
            padding: 0.25rem 0.5rem; border-radius: 0.375rem; 
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-weight: 600;
        }
        .de-error {
            background: linear-gradient(135deg, #fef2f2, #fecaca);
            border: 2px solid #fca5a5; color: #dc2626; 
            padding: 0.75rem; border-radius: 0.5rem;
            margin-top: 0.75rem; font-size: 0.875rem; font-weight: 600;
        }
        .de-buttons {
            display: flex; gap: 0.75rem; margin-top: 1.5rem; flex-wrap: wrap;
        }
        .de-buttons button {
            padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem;
            cursor: pointer; font-size: 0.875rem; font-weight: 600;
            transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .de-buttons .test-btn {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
        }
        .de-buttons .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(251, 191, 36, 0.4);
        }
        .de-buttons .reset-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        .de-buttons .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        @media (max-width: 768px) {
            .canvas-row {
                grid-template-columns: 1fr;
            }
            .container {
                padding: 1rem;
            }
            h1 {
                font-size: 1.5rem;
            }
            .param-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading animation */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        /* Smooth transitions for stats */
        .stats-grid div {
            transition: all 0.3s ease;
        }
        
        .stats-grid div:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .info-panel {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 2px solid #0284c7;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
            color: #0c4a6e;
        }
        .info-panel h3 {
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            color: #0369a1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🌱 Advanced Ecosystem Simulation</h1>

        <div class="canvas-container">
            <canvas id="ecosystemCanvas"></canvas>
            <div class="legend">
                <span class="plant">🌱 Plants</span> 
                <span class="herbivore">🐰 Herbivores</span> 
                <span class="carnivore">🦁 Carnivores</span>
            </div>
        </div>

        <div class="canvas-row">
            <div class="canvas-container">
                <canvas id="atmosphereCanvas"></canvas>
                <div class="legend">
                    <span class="co2">CO₂</span> 
                    <span class="o2">O₂</span> 
                    <span class="n2">N₂</span>
                </div>
            </div>
            <div class="canvas-container">
                <canvas id="pieCanvas"></canvas>
                <div class="legend" style="justify-content: center;">
                    <span style="font-weight: 700;">🌍 Atmospheric Composition</span>
                </div>
            </div>
        </div>

        <div class="canvas-row">
            <div class="canvas-container">
                <canvas id="nitrogenCanvas"></canvas>
                <div class="legend"><span class="an">💧 Available Nitrogen</span></div>
            </div>
            <div class="canvas-container">
                <canvas id="temperatureCanvas"></canvas>
                <div class="legend"><span class="temp">🌡️ Global Temperature</span></div>
            </div>
        </div>

        <div class="controls">
            <button id="startButton">▶️ Start Continuous</button> 
            <button id="stopButton" class="secondary">⏸️ Stop</button>
            <button id="tickButton">⏭️ Step</button> 
            <button id="resetButton" class="secondary">🔄 Reset</button>
        </div>
        <div class="controls">
            <button id="addPlantButton" style="background: linear-gradient(135deg, #22c55e, #16a34a);">🌱 +10 Plants</button>
            <button id="addHerbivoreButton" style="background: linear-gradient(135deg, #a855f7, #9333ea);">🐰 +5 Herbivores</button>
            <button id="addCarnivoreButton" style="background: linear-gradient(135deg, #f97316, #ea580c);">🦁 +2 Carnivores</button>
        </div>

        <div class="stats-container">
            <div class="stats-grid">
                <div id="plantCount">🌱 P: 0</div> 
                <div id="herbivoreCount">🐰 H: 0</div> 
                <div id="carnivoreCount">🦁 C: 0</div>
                <div id="co2Count">CO₂: 0 ppm</div> 
                <div id="o2Count">O₂: 0 ppm</div> 
                <div id="n2Count">N₂: 0 ppm</div>
                <div id="anCount">💧 AN: 0</div> 
                <div id="tempCount">🌡️ Temp: 0°C</div> 
                <div id="timeCount">⏰ Time: 0</div>
                <div id="tempFactorCount">🌡️ Factor: 1.0</div>
            </div>
        </div>

        <div class="controls" style="margin-top: 1.5rem;">
            <button id="toggleDEButton">📝 Show/Hide DE Editor</button>
            <button id="toggleParamsButton">⚙️ Show/Hide Parameters</button>
        </div>

        <div id="deEditorTray" class="de-editor-tray">
            <h2>📝 Enhanced Differential Equation Editor</h2>
            
            <div class="info-panel">
                <h3>🔬 New Ecosystem Features:</h3>
                <p><strong>Nitrogen Cycling:</strong> All biomatter death returns nitrogen to the available pool. Plants consume nitrogen to grow.</p>
                <p><strong>Temperature Effects:</strong> Plant growth and death rates are scaled by temperature deviation from initial conditions.</p>
                <p><strong>Realistic Dynamics:</strong> Temperature factor = exp(-0.1 * |currentTemp - initialTemp|)</p>
            </div>
            
            <div class="de-help">
                <h3>📊 Available Variables:</h3>
                <p><code>P</code> = Plants, <code>H</code> = Herbivores, <code>C</code> = Carnivores, <code>CO2_atm</code> = Atmospheric CO₂, <code>O2_atm</code> = Atmospheric O₂, <code>N2_atm</code> = Atmospheric N₂, <code>AN_pool</code> = Available Nitrogen, <code>t</code> = Time, <code>temp_factor</code> = Temperature scaling factor, <code>current_temp</code> = Current global temperature</p>
                <h3>🔧 Available Functions:</h3>
                <p><code>Math.sin()</code>, <code>Math.cos()</code>, <code>Math.exp()</code>, <code>Math.log()</code>, <code>Math.pow()</code>, <code>Math.sqrt()</code>, <code>Math.abs()</code>, <code>Math.max()</code>, <code>Math.min()</code></p>
                <h3>💡 Enhanced Examples:</h3>
                <p><code>0.1 * P * temp_factor * Math.min(AN_pool / 10, 1) - 0.02 * P * H</code> (Nitrogen-limited plant growth)</p>
                <p><code>0.05 * P * (1 - temp_factor)</code> (Temperature-induced plant death)</p>
            </div>
            
            <div class="de-section">
                <div class="de-equation">
                    <label for="dP_dt">🌱 dP/dt (Plant dynamics - growth limited by nitrogen & temperature):</label>
                    <textarea id="dP_dt" placeholder="Enter differential equation for Plants..."></textarea>
                    <div id="dP_dt_error" class="de-error" style="display: none;"></div>
                </div>
                
                <div class="de-equation">
                    <label for="dH_dt">🐰 dH/dt (Herbivore dynamics - death returns nitrogen):</label>
                    <textarea id="dH_dt" placeholder="Enter differential equation for Herbivores..."></textarea>
                    <div id="dH_dt_error" class="de-error" style="display: none;"></div>
                </div>
                
                <div class="de-equation">
                    <label for="dC_dt">🦁 dC/dt (Carnivore dynamics - death returns nitrogen):</label>
                    <textarea id="dC_dt" placeholder="Enter differential equation for Carnivores..."></textarea>
                    <div id="dC_dt_error" class="de-error" style="display: none;"></div>
                </div>
                
                <div class="de-equation">
                    <label for="dCO2_dt">🏭 dCO₂/dt (CO₂ dynamics):</label>
                    <textarea id="dCO2_dt" placeholder="Enter differential equation for CO₂..."></textarea>
                    <div id="dCO2_dt_error" class="de-error" style="display: none;"></div>
                </div>
                
                <div class="de-equation">
                    <label for="dO2_dt">💨 dO₂/dt (O₂ dynamics):</label>
                    <textarea id="dO2_dt" placeholder="Enter differential equation for O₂..."></textarea>
                    <div id="dO2_dt_error" class="de-error" style="display: none;"></div>
                </div>
                
                <div class="de-equation">
                    <label for="dN2_dt">🌊 dN₂/dt (N₂ atmospheric dynamics):</label>
                    <textarea id="dN2_dt" placeholder="Enter differential equation for N₂..."></textarea>
                    <div id="dN2_dt_error" class="de-error" style="display: none;"></div>
                </div>
                
                <div class="de-equation">
                    <label for="dAN_dt">💧 dAN/dt (Available Nitrogen - gains from death, losses from plant growth):</label>
                    <textarea id="dAN_dt" placeholder="Enter differential equation for Available Nitrogen..."></textarea>
                    <div id="dAN_dt_error" class="de-error" style="display: none;"></div>
                </div>
            </div>
            
            <div class="de-buttons">
                <button class="test-btn" id="testDEButton">🧪 Test Equations</button>
                <button class="reset-btn" id="resetDEButton">🔄 Reset to Enhanced Default</button>
            </div>
        </div>

        <div id="parameterTray" class="parameter-tray">
            <div class="param-section">
                <h2>⚙️ Enhanced Parameters</h2>
                <div class="param-grid">
                    <div class="param-item">
                        <label for="param_initialP">🌱 Initial Plants</label>
                        <input type="number" id="param_initialP" step="1" min="0">
                    </div>
                    <div class="param-item">
                        <label for="param_initialH">🐰 Initial Herbivores</label>
                        <input type="number" id="param_initialH" step="1" min="0">
                    </div>
                    <div class="param-item">
                        <label for="param_initialC">🦁 Initial Carnivores</label>
                        <input type="number" id="param_initialC" step="1" min="0">
                    </div>
                    <div class="param-item">
                        <label for="param_initialCO2_atm">🏭 Initial CO₂ (ppm)</label>
                        <input type="number" id="param_initialCO2_atm" step="10" min="0">
                    </div>
                    <div class="param-item">
                        <label for="param_initialO2_atm">💨 Initial O₂ (ppm)</label>
                        <input type="number" id="param_initialO2_atm" step="1000" min="0">
                    </div>
                    <div class="param-item">
                        <label for="param_initialN2_atm">🌊 Initial N₂ (ppm)</label>
                        <input type="number" id="param_initialN2_atm" step="1000" min="0">
                    </div>
                    <div class="param-item">
                        <label for="param_initialAN_pool">💧 Initial Available Nitrogen</label>
                        <input type="number" id="param_initialAN_pool" step="1" min="0">
                    </div>
                    <div class="param-item">
                        <label for="param_initialGT">🌡️ Initial Temperature (°C)</label>
                        <input type="number" id="param_initialGT" step="0.1">
                    </div>
                    <div class="param-item">
                        <label for="param_tempSensitivity">🌡️ Temperature Sensitivity</label>
                        <input type="number" id="param_tempSensitivity" step="0.01" min="0" max="1">
                    </div>
                    <div class="param-item">
                        <label for="param_nitrogenEfficiency">💧 Nitrogen Use Efficiency</label>
                        <input type="number" id="param_nitrogenEfficiency" step="0.1" min="0.1" max="10">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="messageBox" class="message-box"></div>
    
    <script>
        // Enhanced configuration with new parameters
        const CONFIG = {
            COLORS: {
                PLANT: '#22c55e',
                HERBIVORE: '#a855f7', 
                CARNIVORE: '#f97316',
                CO2: '#71717a',
                O2: '#3b82f6',
                N2: '#8b5cf6',
                AN: '#eab308',
                TEMP: '#ef4444'
            },
            ANIMATION: {
                TIME_STEP: 0.1,
                MAX_HISTORY: 500,
                FPS: 60
            },
            VALIDATION: {
                MIN_VALUES: {
                    P: 0, H: 0, C: 0, CO2_atm: 0, O2_atm: 0, N2_atm: 0, AN_pool: 0
                },
                MAX_VALUES: {
                    P: 10000, H: 10000, C: 10000, 
                    CO2_atm: 100000, O2_atm: 1000000, N2_atm: 1000000, 
                    AN_pool: 10000
                }
            }
        };

        const DEFAULT_PARAMS = {
            initialP: 50, initialH: 15, initialC: 5, 
            initialCO2_atm: 400, initialO2_atm: 210000, 
            initialN2_atm: 780000, initialAN_pool: 100, initialGT: 15.0,
            tempSensitivity: 0.1, nitrogenEfficiency: 1.0
        };

        // Enhanced differential equations with nitrogen cycling and temperature effects
        const DEFAULT_DES = {
            dP_dt: `
                // Temperature factor affects growth and death
                // Nitrogen limitation affects growth
                let growth = 0.15 * P * temp_factor * Math.min(AN_pool / (10 * nitrogenEfficiency), 1) * (1 - P / 200);
                let predation = 0.02 * P * H;
                let temp_death = 0.03 * P * (1 - temp_factor);
                return growth - predation - temp_death;
            `.trim(),
            
            dH_dt: `
                // Herbivores gain from plants, lose to carnivores and natural death
                let growth = 0.008 * P * H;
                let predation = 0.012 * H * C;
                let natural_death = 0.08 * H;
                return growth - predation - natural_death;
            `.trim(),
            
            dC_dt: `
                // Carnivores gain from herbivores, natural death
                let growth = 0.003 * H * C;
                let natural_death = 0.06 * C;
                return growth - natural_death;
            `.trim(),
            
            dCO2_dt: `
                // CO2 from respiration, removed by photosynthesis
                let respiration = 0.5 * (H + C) + 0.1 * P * (1 - temp_factor);
                let photosynthesis = 0.12 * P * temp_factor;
                let seasonal = Math.sin(t * 0.02) * 2;
                return respiration - photosynthesis + seasonal;
            `.trim(),
            
            dO2_dt: `
                // O2 from photosynthesis, consumed by respiration
                let photosynthesis = 0.12 * P * temp_factor;
                let respiration = 0.008 * (H + C);
                return photosynthesis - respiration;
            `.trim(),
            
            dN2_dt: `
                // N2 from denitrification, some atmospheric exchange
                let denitrification = 0.02 * AN_pool;
                let atmospheric_exchange = 0.01;
                return denitrification - atmospheric_exchange;
            `.trim(),
            
            dAN_dt: `
                // Available nitrogen increases from death, decreases from plant uptake
                let death_returns = 0.08 * H + 0.06 * C + 0.03 * P * (1 - temp_factor);
                let plant_uptake = 0.02 * P * temp_factor * Math.min(AN_pool / nitrogenEfficiency, P);
                let nitrogen_fixation = 0.05 + 0.01 * P * temp_factor;
                let atmospheric_input = 0.01;
                return death_returns - plant_uptake + nitrogen_fixation + atmospheric_input;
            `.trim()
        };

        // State management
        class SimulationState {
            constructor() {
                this.reset();
            }

            reset() {
                this.currentTime = 0;
                this.simulationRunning = false;
                this.animationFrameId = null;
                this.lastFrameTime = 0;
                this.systemState = {};
                this.globalTemp = 0;
                this.tempFactor = 1.0;
                this.history = [];
                this.simParams = { ...DEFAULT_PARAMS };
                this.customDEs = { ...DEFAULT_DES };
                this.compiledDEs = {};
            }

            validate() {
                Object.keys(this.systemState).forEach(key => {
                    const value = this.systemState[key];
                    const min = CONFIG.VALIDATION.MIN_VALUES[key] ?? -Infinity;
                    const max = CONFIG.VALIDATION.MAX_VALUES[key] ?? Infinity;
                    
                    if (value < min) this.systemState[key] = min;
                    if (value > max) this.systemState[key] = max;
                    if (isNaN(value) || !isFinite(value)) this.systemState[key] = min;
                });
            }
        }

        // UI Management
        class UIManager {
            constructor() {
                this.elements = this.initializeElements();
                this.setupEventListeners();
            }

            initializeElements() {
                return {
                    // Canvases
                    ecoCanvas: document.getElementById('ecosystemCanvas'),
                    atmCanvas: document.getElementById('atmosphereCanvas'),
                    nitroCanvas: document.getElementById('nitrogenCanvas'),
                    tempCanvas: document.getElementById('temperatureCanvas'),
                    pieCanvas: document.getElementById('pieCanvas'),
                    
                    // Controls
                    startButton: document.getElementById('startButton'),
                    stopButton: document.getElementById('stopButton'),
                    tickButton: document.getElementById('tickButton'),
                    resetButton: document.getElementById('resetButton'),
                    addPlant: document.getElementById('addPlantButton'),
                    addHerbivore: document.getElementById('addHerbivoreButton'),
                    addCarnivore: document.getElementById('addCarnivoreButton'),
                    
                    // Panels
                    toggleParams: document.getElementById('toggleParamsButton'),
                    toggleDE: document.getElementById('toggleDEButton'),
                    paramTray: document.getElementById('parameterTray'),
                    deTray: document.getElementById('deEditorTray'),
                    
                    // Stats
                    plantCount: document.getElementById('plantCount'),
                    herbivoreCount: document.getElementById('herbivoreCount'),
                    carnivoreCount: document.getElementById('carnivoreCount'),
                    co2Count: document.getElementById('co2Count'),
                    o2Count: document.getElementById('o2Count'),
                    n2Count: document.getElementById('n2Count'),
                    anCount: document.getElementById('anCount'),
                    tempCount: document.getElementById('tempCount'),
                    timeCount: document.getElementById('timeCount'),
                    tempFactorCount: document.getElementById('tempFactorCount'),
                    
                    // DE Editor
                    testDE: document.getElementById('testDEButton'),
                    resetDE: document.getElementById('resetDEButton'),
                    messageBox: document.getElementById('messageBox')
                };
            }

            setupEventListeners() {
                // Control buttons
                this.elements.startButton.addEventListener('click', () => simulation.start());
                this.elements.stopButton.addEventListener('click', () => simulation.stop());
                this.elements.tickButton.addEventListener('click', () => simulation.tick());
                this.elements.resetButton.addEventListener('click', () => simulation.reset());
                
                // Add organisms
                this.elements.addPlant.addEventListener('click', () => simulation.addOrganism('plant', 10));
                this.elements.addHerbivore.addEventListener('click', () => simulation.addOrganism('herbivore', 5));
                this.elements.addCarnivore.addEventListener('click', () => simulation.addOrganism('carnivore', 2));
                
                // Panel toggles
                this.elements.toggleParams.addEventListener('click', () => this.togglePanel('params'));
                this.elements.toggleDE.addEventListener('click', () => this.togglePanel('de'));
                
                // DE Editor
                this.elements.testDE.addEventListener('click', () => deManager.test());
                this.elements.resetDE.addEventListener('click', () => deManager.resetToDefault());
                
                // Window resize
                window.addEventListener('resize', () => {
                    this.resizeCanvases();
                    graphManager.renderAll();
                });
            }

            togglePanel(type) {
                const panel = type === 'params' ? this.elements.paramTray : this.elements.deTray;
                panel.classList.toggle('open');
            }

            showMessage(text, duration = 2000, isError = false) {
                const messageBox = this.elements.messageBox;
                messageBox.textContent = text;
                messageBox.className = `message-box ${isError ? 'error' : ''}`;
                messageBox.style.display = 'block';
                
                setTimeout(() => {
                    messageBox.style.display = 'none';
                }, duration);
            }

            updateStats(state) {
                this.elements.plantCount.textContent = `🌱 P: ${Math.round(state.systemState.P)}`;
                this.elements.herbivoreCount.textContent = `🐰 H: ${Math.round(state.systemState.H)}`;
                this.elements.carnivoreCount.textContent = `🦁 C: ${Math.round(state.systemState.C)}`;
                this.elements.co2Count.textContent = `CO₂: ${Math.round(state.systemState.CO2_atm)} ppm`;
                this.elements.o2Count.textContent = `O₂: ${(state.systemState.O2_atm/1000).toFixed(0)}k ppm`;
                this.elements.n2Count.textContent = `N₂: ${(state.systemState.N2_atm/1000).toFixed(0)}k ppm`;
                this.elements.anCount.textContent = `💧 AN: ${Math.round(state.systemState.AN_pool)}`;
                this.elements.tempCount.textContent = `🌡️ ${state.globalTemp.toFixed(1)}°C`;
                this.elements.timeCount.textContent = `⏰ ${state.currentTime.toFixed(1)}`;
                this.elements.tempFactorCount.textContent = `🌡️ Factor: ${state.tempFactor.toFixed(2)}`;
            }

            setSimulationControls(running) {
                this.elements.startButton.disabled = running;
                this.elements.stopButton.disabled = !running;
                this.elements.tickButton.disabled = running;
            }

            resizeCanvases() {
                [this.elements.ecoCanvas, this.elements.atmCanvas, this.elements.nitroCanvas, 
                 this.elements.tempCanvas, this.elements.pieCanvas].forEach(canvas => {
                    const rect = canvas.getBoundingClientRect();
                    canvas.width = rect.width * window.devicePixelRatio;
                    canvas.height = rect.height * window.devicePixelRatio;
                    const ctx = canvas.getContext('2d');
                    ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
                });
            }
        }

        // Parameter Management
        class ParameterManager {
            constructor() {
                this.inputs = {};
                this.setupInputs();
            }

            setupInputs() {
                Object.keys(DEFAULT_PARAMS).forEach(key => {
                    const input = document.getElementById(`param_${key}`);
                    if (input) {
                        input.value = DEFAULT_PARAMS[key];
                        input.addEventListener('change', () => this.validateInput(input, key));
                        this.inputs[key] = input;
                    }
                });
            }

            validateInput(input, key) {
                let value = parseFloat(input.value);
                const min = CONFIG.VALIDATION.MIN_VALUES[key] ?? -Infinity;
                const max = CONFIG.VALIDATION.MAX_VALUES[key] ?? Infinity;
                
                if (isNaN(value)) value = DEFAULT_PARAMS[key];
                if (value < min) value = min;
                if (value > max) value = max;
                
                input.value = value;
            }

            getParams() {
                const params = {};
                Object.keys(DEFAULT_PARAMS).forEach(key => {
                    if (this.inputs[key]) {
                        params[key] = parseFloat(this.inputs[key].value) || DEFAULT_PARAMS[key];
                    } else {
                        params[key] = DEFAULT_PARAMS[key];
                    }
                });
                return params;
            }
        }

        // Enhanced Differential Equation Management
        class DEManager {
            constructor() {
                this.inputs = {};
                this.setupInputs();
            }

            setupInputs() {
                Object.keys(DEFAULT_DES).forEach(key => {
                    const input = document.getElementById(key);
                    if (input) {
                        input.value = DEFAULT_DES[key];
                        this.inputs[key] = input;
                    }
                });
            }

            compile(state) {
                const errors = {};
                const compiled = {};
                
                // Update custom DEs from inputs
                Object.keys(this.inputs).forEach(key => {
                    if (this.inputs[key]) {
                        state.customDEs[key] = this.inputs[key].value;
                    }
                });
                
                Object.keys(state.customDEs).forEach(key => {
                    try {
                        const errorDiv = document.getElementById(key + '_error');
                        if (errorDiv) errorDiv.style.display = 'none';
                        
                        if (state.customDEs[key].trim() === '') {
                            compiled[key] = () => 0;
                            return;
                        }
                        
                        // Create enhanced evaluation function with additional variables
                        const func = new Function(
                            'P', 'H', 'C', 'CO2_atm', 'O2_atm', 'N2_atm', 'AN_pool', 't', 'Math',
                            'temp_factor', 'current_temp', 'nitrogenEfficiency',
                            `try { 
                                ${state.customDEs[key]} 
                            } catch(e) { 
                                throw new Error('Runtime error: ' + e.message); 
                            }`
                        );
                        compiled[key] = func;
                        
                    } catch (error) {
                        errors[key] = error.message;
                        const errorDiv = document.getElementById(key + '_error');
                        if (errorDiv) {
                            errorDiv.textContent = `Error: ${error.message}`;
                            errorDiv.style.display = 'block';
                        }
                        compiled[key] = () => 0;
                    }
                });
                
                state.compiledDEs = compiled;
                return Object.keys(errors).length === 0 ? null : errors;
            }

            test() {
                const testState = { 
                    P: 50, H: 15, C: 5, CO2_atm: 400, O2_atm: 210000, N2_atm: 780000, AN_pool: 100 
                };
                const testTime = 1.0;
                const testTempFactor = 0.8;
                const testCurrentTemp = 16.5;
                const testNitrogenEff = 1.0;
                
                const errors = this.compile(simulationState);
                if (errors) {
                    ui.showMessage('DE compilation errors found. Check error messages below.', 3000, true);
                    return;
                }
                
                try {
                    const results = {};
                    Object.keys(simulationState.compiledDEs).forEach(key => {
                        const result = simulationState.compiledDEs[key](
                            testState.P, testState.H, testState.C, 
                            testState.CO2_atm, testState.O2_atm, testState.N2_atm, testState.AN_pool,
                            testTime, Math, testTempFactor, testCurrentTemp, testNitrogenEff
                        );
                        results[key] = result;
                    });
                    
                    const resultStr = Object.entries(results)
                        .map(([key, value]) => `${key}: ${value.toFixed(3)}`)
                        .join(', ');
                    ui.showMessage(`✅ Enhanced Test Results: ${resultStr}`, 4000);
                } catch (error) {
                    ui.showMessage(`❌ Test Error: ${error.message}`, 3000, true);
                }
            }

            resetToDefault() {
                Object.keys(DEFAULT_DES).forEach(key => {
                    if (this.inputs[key]) {
                        this.inputs[key].value = DEFAULT_DES[key];
                    }
                });
                simulationState.customDEs = { ...DEFAULT_DES };
                this.compile(simulationState);
                ui.showMessage('🔄 DEs reset to enhanced default with nitrogen cycling & temperature effects');
            }
        }

        // Enhanced Physics Engine
        class PhysicsEngine {
            static calculateDerivatives(currentState, t, state) {
                try {
                    const results = {};
                    
                    Object.keys(state.compiledDEs).forEach(varName => {
                        const varKey = varName.replace('d', '').replace('_dt', '');
                        if (state.compiledDEs[varName]) {
                            results[varKey] = state.compiledDEs[varName](
                                currentState.P, currentState.H, currentState.C,
                                currentState.CO2_atm, currentState.O2_atm, currentState.N2_atm, 
                                currentState.AN_pool, t, Math,
                                state.tempFactor, state.globalTemp, state.simParams.nitrogenEfficiency
                            );
                        } else {
                            results[varKey] = 0;
                        }
                    });
                    
                    return results;
                } catch (error) {
                    console.error('Error in derivatives calculation:', error);
                    return { P: 0, H: 0, C: 0, CO2_atm: 0, O2_atm: 0, N2_atm: 0, AN_pool: 0 };
                }
            }

            static rk4Step(currentState, dt, t, state) {
                const k1 = this.calculateDerivatives(currentState, t, state);
                
                const y_k1 = {};
                Object.keys(currentState).forEach(key => {
                    y_k1[key] = currentState[key] + k1[key] * dt / 2;
                });
                
                const k2 = this.calculateDerivatives(y_k1, t + dt / 2, state);
                
                const y_k2 = {};
                Object.keys(currentState).forEach(key => {
                    y_k2[key] = currentState[key] + k2[key] * dt / 2;
                });
                
                const k3 = this.calculateDerivatives(y_k2, t + dt / 2, state);
                
                const y_k3 = {};
                Object.keys(currentState).forEach(key => {
                    y_k3[key] = currentState[key] + k3[key] * dt;
                });
                
                const k4 = this.calculateDerivatives(y_k3, t + dt, state);
                
                const newState = {};
                Object.keys(currentState).forEach(key => {
                    newState[key] = currentState[key] + (k1[key] + 2 * k2[key] + 2 * k3[key] + k4[key]) * dt / 6;
                });
                
                return newState;
            }

            static updateGlobalTemp(state) {
                const baseCO2 = 280;
                const currentCO2 = Math.max(state.systemState.CO2_atm, 1);
                const sensitivity = 3.0; // Climate sensitivity
                const tempChange = sensitivity * Math.log(currentCO2 / baseCO2) / Math.log(2);
                state.globalTemp = state.simParams.initialGT + tempChange;
                
                // Calculate temperature factor for biological processes
                const tempDiff = Math.abs(state.globalTemp - state.simParams.initialGT);
                state.tempFactor = Math.exp(-state.simParams.tempSensitivity * tempDiff);
            }
        }

        // Enhanced Graphics Manager (same as before, but with tempFactor in history)
        class GraphManager {
            constructor() {
                this.ui = ui;
            }

            drawTimeSeriesGraph(canvas, ctx, data, variableNames, colors, title, yAxisLabel) {
                const rect = canvas.getBoundingClientRect();
                const width = rect.width;
                const height = rect.height;
                
                ctx.clearRect(0, 0, width, height);
                
                if (data.length < 2) return;
                
                const padding = { left: 70, right: 30, top: 50, bottom: 40 };
                const graphWidth = width - padding.left - padding.right;
                const graphHeight = height - padding.top - padding.bottom;
                
                // Background
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(padding.left, padding.top, graphWidth, graphHeight);
                
                // Grid lines
                ctx.strokeStyle = '#f1f5f9';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 10; i++) {
                    const y = padding.top + (graphHeight * i) / 10;
                    ctx.beginPath();
                    ctx.moveTo(padding.left, y);
                    ctx.lineTo(padding.left + graphWidth, y);
                    ctx.stroke();
                    
                    const x = padding.left + (graphWidth * i) / 10;
                    ctx.beginPath();
                    ctx.moveTo(x, padding.top);
                    ctx.lineTo(x, padding.top + graphHeight);
                    ctx.stroke();
                }
                
                // Calculate ranges
                let allValues = [];
                variableNames.forEach(varName => {
                    data.forEach(point => {
                        if (point[varName] !== undefined && isFinite(point[varName])) {
                            allValues.push(point[varName]);
                        }
                    });
                });
                
                if (allValues.length === 0) return;
                
                let minY = Math.min(...allValues);
                let maxY = Math.max(...allValues);
                
                // Add padding to y-range
                const yRange = maxY - minY;
                if (yRange === 0) {
                    minY -= 1;
                    maxY += 1;
                } else {
                    const padding_y = yRange * 0.1;
                    minY -= padding_y;
                    maxY += padding_y;
                }
                
                const minX = data[0].time;
                const maxX = data[data.length - 1].time;
                const xRange = maxX - minX || 1;
                
                // Draw data lines
                variableNames.forEach((varName, index) => {
                    const color = colors[index];
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    
                    let firstPoint = true;
                    data.forEach(point => {
                        if (point[varName] === undefined || !isFinite(point[varName])) return;
                        
                        const x = padding.left + ((point.time - minX) / xRange) * graphWidth;
                        const y = padding.top + graphHeight - ((point[varName] - minY) / (maxY - minY)) * graphHeight;
                        
                        if (firstPoint) {
                            ctx.moveTo(x, y);
                            firstPoint = false;
                        } else {
                            ctx.lineTo(x, y);
                        }
                    });
                    ctx.stroke();
                });
                
                // Border
                ctx.strokeStyle = '#374151';
                ctx.lineWidth = 2;
                ctx.strokeRect(padding.left, padding.top, graphWidth, graphHeight);
                
                // Title
                ctx.fillStyle = '#1f2937';
                ctx.font = 'bold 16px Inter';
                ctx.textAlign = 'center';
                ctx.fillText(title, width / 2, 25);
                
                // Y-axis labels
                ctx.font = '12px Inter';
                ctx.textAlign = 'right';
                ctx.fillStyle = '#4b5563';
                for (let i = 0; i <= 5; i++) {
                    const y = padding.top + (graphHeight * i) / 5;
                    const labelValue = maxY - ((maxY - minY) * i) / 5;
                    let formatted = labelValue >= 1000 ? 
                        `${(labelValue/1000).toFixed(1)}k` : 
                        labelValue.toFixed(1);
                    ctx.fillText(formatted, padding.left - 10, y + 4);
                }
                
                // Y-axis title
                ctx.save();
                ctx.translate(20, height / 2);
                ctx.rotate(-Math.PI / 2);
                ctx.font = 'bold 14px Inter';
                ctx.textAlign = 'center';
                ctx.fillText(yAxisLabel, 0, 0);
                ctx.restore();
                
                // X-axis labels
                ctx.textAlign = 'center';
                for (let i = 0; i <= 5; i++) {
                    const x = padding.left + (graphWidth * i) / 5;
                    const timeValue = minX + ((maxX - minX) * i) / 5;
                    ctx.fillText(timeValue.toFixed(1), x, height - 10);
                }
            }

            drawPieChart(canvas, ctx, data) {
                const rect = canvas.getBoundingClientRect();
                const width = rect.width;
                const height = rect.height;
                
                ctx.clearRect(0, 0, width, height);
                
                if (data.length === 0) return;
                
                const latest = data[data.length - 1];
                const total = latest.CO2_atm + latest.O2_atm + latest.N2_atm;
                
                if (total <= 0) return;
                
                const centerX = width / 2;
                const centerY = height / 2 + 10;
                const radius = Math.min(width, height) / 2 - 60;
                
                const slices = [
                    { name: 'N₂', value: latest.N2_atm, color: CONFIG.COLORS.N2 },
                    { name: 'O₂', value: latest.O2_atm, color: CONFIG.COLORS.O2 },
                    { name: 'CO₂', value: latest.CO2_atm, color: CONFIG.COLORS.CO2 }
                ];
                
                let currentAngle = -Math.PI / 2;
                
                slices.forEach(slice => {
                    const sliceAngle = (slice.value / total) * 2 * Math.PI;
                    
                    // Draw slice
                    ctx.fillStyle = slice.color;
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Draw border
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    
                    // Draw labels only if slice is large enough
                    const percentage = (slice.value / total) * 100;
                    if (percentage > 5) {
                        const labelAngle = currentAngle + sliceAngle / 2;
                        const labelRadius = radius * 0.7;
                        const labelX = centerX + Math.cos(labelAngle) * labelRadius;
                        const labelY = centerY + Math.sin(labelAngle) * labelRadius;
                        
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 14px Inter';
                        ctx.textAlign = 'center';
                        ctx.strokeStyle = '#000000';
                        ctx.lineWidth = 3;
                        
                        ctx.strokeText(slice.name, labelX, labelY - 5);
                        ctx.fillText(slice.name, labelX, labelY - 5);
                        
                        ctx.font = '12px Inter';
                        ctx.strokeText(`${percentage.toFixed(1)}%`, labelX, labelY + 12);
                        ctx.fillText(`${percentage.toFixed(1)}%`, labelX, labelY + 12);
                    }
                    
                    currentAngle += sliceAngle;
                });
                
                // Title
                ctx.fillStyle = '#1f2937';
                ctx.font = 'bold 16px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('Atmospheric Composition', centerX, 25);
                
                // Total
                ctx.font = '12px Inter';
                ctx.fillStyle = '#6b7280';
                ctx.fillText(`Total: ${(total/1000).toFixed(0)}k ppm`, centerX, height - 15);
            }

            renderAll() {
                const data = simulationState.history;
                
                this.drawTimeSeriesGraph(
                    this.ui.elements.ecoCanvas, this.ui.elements.ecoCanvas.getContext('2d'), data,
                    ['P', 'H', 'C'],
                    [CONFIG.COLORS.PLANT, CONFIG.COLORS.HERBIVORE, CONFIG.COLORS.CARNIVORE],
                    '🌱 Enhanced Ecosystem Dynamics', 'Population Count'
                );
                
                this.drawTimeSeriesGraph(
                    this.ui.elements.atmCanvas, this.ui.elements.atmCanvas.getContext('2d'), data,
                    ['CO2_atm', 'O2_atm', 'N2_atm'],
                    [CONFIG.COLORS.CO2, CONFIG.COLORS.O2, CONFIG.COLORS.N2],
                    '🌍 Atmospheric Gas Concentrations', 'Concentration (ppm)'
                );
                
                this.drawTimeSeriesGraph(
                    this.ui.elements.nitroCanvas, this.ui.elements.nitroCanvas.getContext('2d'), data,
                    ['AN_pool'],
                    [CONFIG.COLORS.AN],
                    '💧 Nitrogen Cycle with Death Returns', 'Available Nitrogen'
                );
                
                this.drawTimeSeriesGraph(
                    this.ui.elements.tempCanvas, this.ui.elements.tempCanvas.getContext('2d'), data,
                    ['globalTemp'],
                    [CONFIG.COLORS.TEMP],
                    '🌡️ Climate-Driven Temperature', 'Temperature (°C)'
                );
                
                this.drawPieChart(
                    this.ui.elements.pieCanvas, this.ui.elements.pieCanvas.getContext('2d'), data
                );
            }
        }

        // Enhanced Main Simulation Controller
        class Simulation {
            constructor(state, ui, paramManager, deManager, graphManager) {
                this.state = state;
                this.ui = ui;
                this.paramManager = paramManager;
                this.deManager = deManager;
                this.graphManager = graphManager;
            }

            initialize() {
                this.state.simParams = this.paramManager.getParams();
                this.state.systemState = {
                    P: this.state.simParams.initialP,
                    H: this.state.simParams.initialH,
                    C: this.state.simParams.initialC,
                    CO2_atm: this.state.simParams.initialCO2_atm,
                    O2_atm: this.state.simParams.initialO2_atm,
                    N2_atm: this.state.simParams.initialN2_atm,
                    AN_pool: this.state.simParams.initialAN_pool
                };
                
                this.state.currentTime = 0;
                this.state.history = [];
                
                PhysicsEngine.updateGlobalTemp(this.state);
                this.addHistoryPoint();
            }

            addHistoryPoint() {
                if (this.state.history.length >= CONFIG.ANIMATION.MAX_HISTORY) {
                    this.state.history.shift();
                }
                
                this.state.history.push({
                    time: this.state.currentTime,
                    P: this.state.systemState.P,
                    H: this.state.systemState.H,
                    C: this.state.systemState.C,
                    CO2_atm: this.state.systemState.CO2_atm,
                    O2_atm: this.state.systemState.O2_atm,
                    N2_atm: this.state.systemState.N2_atm,
                    AN_pool: this.state.systemState.AN_pool,
                    globalTemp: this.state.globalTemp,
                    tempFactor: this.state.tempFactor
                });
            }

            step() {
                this.state.simParams = this.paramManager.getParams();
                
                this.state.systemState = PhysicsEngine.rk4Step(
                    this.state.systemState, 
                    CONFIG.ANIMATION.TIME_STEP, 
                    this.state.currentTime, 
                    this.state
                );
                
                this.state.validate();
                this.state.currentTime += CONFIG.ANIMATION.TIME_STEP;
                PhysicsEngine.updateGlobalTemp(this.state);
                this.addHistoryPoint();
            }

            gameLoop(currentTime) {
                if (!this.state.simulationRunning) return;
                
                // Throttle to target FPS
                if (currentTime - this.state.lastFrameTime >= 1000 / CONFIG.ANIMATION.FPS) {
                    this.step();
                    this.ui.updateStats(this.state);
                    this.graphManager.renderAll();
                    this.state.lastFrameTime = currentTime;
                }
                
                this.state.animationFrameId = requestAnimationFrame((time) => this.gameLoop(time));
            }

            start() {
                if (this.state.simulationRunning) return;
                
                const errors = this.deManager.compile(this.state);
                if (errors) {
                    this.ui.showMessage('❌ Cannot start: DE compilation errors. Check equations.', 3000, true);
                    return;
                }
                
                this.state.simulationRunning = true;
                this.ui.setSimulationControls(true);
                this.state.lastFrameTime = 0;
                this.gameLoop(0);
                this.ui.showMessage('▶️ Enhanced simulation started with nitrogen cycling & temperature effects');
            }

            stop() {
                this.state.simulationRunning = false;
                this.ui.setSimulationControls(false);
                if (this.state.animationFrameId) {
                    cancelAnimationFrame(this.state.animationFrameId);
                }
                this.ui.showMessage('⏸️ Simulation stopped');
            }

            tick() {
                const errors = this.deManager.compile(this.state);
                if (errors) {
                    this.ui.showMessage('❌ Cannot step: DE compilation errors. Check equations.', 3000, true);
                    return;
                }
                
                this.step();
                this.ui.updateStats(this.state);
                this.graphManager.renderAll();
                this.ui.showMessage('⏭️ Advanced one step');
            }

            reset() {
                this.stop();
                this.initialize();
                this.ui.updateStats(this.state);
                this.graphManager.renderAll();
                this.ui.showMessage('🔄 Enhanced simulation reset');
            }

            addOrganism(type, count) {
                switch(type) {
                    case 'plant': this.state.systemState.P += count; break;
                    case 'herbivore': this.state.systemState.H += count; break;
                    case 'carnivore': this.state.systemState.C += count; break;
                }
                this.state.validate();
                this.ui.updateStats(this.state);
                this.ui.showMessage(`➕ Added ${count} ${type}s`);
            }
        }

        // Initialize enhanced application
        const simulationState = new SimulationState();
        const ui = new UIManager();
        const paramManager = new ParameterManager();
        const deManager = new DEManager();
        const graphManager = new GraphManager();
        const simulation = new Simulation(simulationState, ui, paramManager, deManager, graphManager);

        // Setup and start
        ui.resizeCanvases();
        simulation.initialize();
        deManager.compile(simulationState);
        ui.updateStats(simulationState);
        graphManager.renderAll();

        // Show enhanced welcome message
        ui.showMessage('🌱 Enhanced Ecosystem Simulation Ready! Now with nitrogen cycling & temperature effects!', 4000);
    </script>
</body>
</html>