
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Ecosystem Simulation with DE Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif; display: flex; flex-direction: column;
            align-items: center; justify-content: flex-start; min-height: 100vh;
            background-color: #f0f4f8; margin: 0; padding: 1rem; color: #333;
        }
        .container {
            background-color: white; padding: 1.5rem; border-radius: 0.75rem;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            width: 100%; max-width: 1400px; 
        }
        .canvas-container { margin-bottom: 1rem; }
        .canvas-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        canvas {
            display: block; background-color: #e2e8f0; border-radius: 0.5rem;
            width: 100%; cursor: default;
        }
        #ecosystemCanvas { height: 280px; }
        #atmosphereCanvas { height: 220px; } 
        #nitrogenCanvas { height: 180px; }
        #temperatureCanvas { height: 180px; }
        #pieCanvas { height: 220px; }

        .controls, .stats-container {
            margin-top: 1rem; display: flex; flex-wrap: wrap;
            gap: 0.75rem; justify-content: center;
        }
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
            gap: 0.5rem; justify-content: center; width: 100%;
        }
        .controls button, .stats-grid div {
            padding: 0.5rem 0.8rem; border-radius: 0.5rem; font-weight: 500;
            transition: all 0.2s ease-in-out; font-size: 0.75rem; 
        }
        .controls button {
            background-color: #3b82f6; color: white; border: none;
            cursor: pointer; font-size: 0.875rem;
        }
        .controls button:hover { background-color: #2563eb; }
        .controls button.secondary { background-color: #6b7280; }
        .controls button.secondary:hover { background-color: #4b5563; }
        .stats-grid div {
            background-color: #f3f4f6; color: #1f2937; text-align: center;
        }
        .message-box {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background-color: #22c55e; color: white; padding: 1rem 1.5rem;
            border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000; display: none; font-size: 0.9rem;
        }
        h1 {
            font-size: 1.75rem; font-weight: 600; margin-bottom: 0.5rem; 
            text-align: center; color: #1e3a8a;
        }
        .legend {
            display: flex; justify-content: center; flex-wrap: wrap;
            gap: 0.8rem; margin-top: 0.25rem; margin-bottom: 0.75rem;
            font-size: 0.75rem; 
        }
        .legend span { display: flex; align-items: center; }
        .legend span::before {
            content: ''; width: 9px; height: 9px; 
            border-radius: 2px; margin-right: 0.25rem; display: inline-block;
        }
        .legend .plant::before { background-color: #4ade80; }
        .legend .herbivore::before { background-color: #c084fc; }
        .legend .carnivore::before { background-color: #fb923c; }
        .legend .co2::before { background-color: #71717a; } 
        .legend .o2::before { background-color: #60a5fa; }  
        .legend .n2::before { background-color: #a78bfa; }  
        .legend .an::before { background-color: #facc15; }  
        .legend .temp::before { background-color: #ef4444; }

        .parameter-tray, .de-editor-tray {
            background-color: #f9fafb; border: 1px solid #e5e7eb;
            border-radius: 0.5rem; padding: 0; margin-top: 1rem;
            max-height: 0; overflow-y: auto;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
        }
        .parameter-tray.open { max-height: 2200px; padding: 1rem; }
        .de-editor-tray.open { max-height: 800px; padding: 1rem; }
        .parameter-tray h2, .de-editor-tray h2 {
            font-size: 1.05rem; font-weight: 600; 
            margin-bottom: 0.6rem; color: #374151;
            border-bottom: 1px solid #e5e7eb; padding-bottom: 0.4rem;
        }
        .param-section, .de-section { margin-bottom: 0.8rem; }
        .param-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.6rem;
        }
        .param-item { display: flex; flex-direction: column; }
        .param-item label {
            font-size: 0.75rem; color: #4b5563; margin-bottom: 0.2rem;
        }
        .param-item input[type="number"] {
            padding: 0.35rem; border: 1px solid #d1d5db;
            border-radius: 0.375rem; font-size: 0.75rem; width: 100%;
        }
        .param-item input[type="number"]:focus {
            outline: none; border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        #toggleParamsButton { margin-top: 1rem; background-color: #10b981; }
        #toggleParamsButton:hover { background-color: #059669; }
        #toggleDEButton { margin-top: 1rem; background-color: #8b5cf6; }
        #toggleDEButton:hover { background-color: #7c3aed; }

        .de-equation {
            margin-bottom: 1rem; padding: 1rem; border: 1px solid #d1d5db;
            border-radius: 0.5rem; background-color: white;
        }
        .de-equation label {
            display: block; font-weight: 600; margin-bottom: 0.5rem;
            color: #374151; font-size: 0.9rem;
        }
        .de-equation textarea {
            width: 100%; height: 80px; padding: 0.5rem;
            border: 1px solid #d1d5db; border-radius: 0.375rem;
            font-family: 'Courier New', monospace; font-size: 0.8rem;
            resize: vertical;
        }
        .de-equation textarea:focus {
            outline: none; border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        .de-help {
            background-color: #eff6ff; border: 1px solid #bfdbfe;
            border-radius: 0.375rem; padding: 0.75rem; margin-bottom: 1rem;
            font-size: 0.8rem; color: #1e40af;
        }
        .de-help h3 {
            font-weight: 600; margin-bottom: 0.5rem; font-size: 0.85rem;
        }
        .de-help code {
            background-color: #dbeafe; padding: 0.1rem 0.25rem;
            border-radius: 0.25rem; font-family: 'Courier New', monospace;
        }
        .de-error {
            background-color: #fef2f2; border: 1px solid #fecaca;
            color: #dc2626; padding: 0.5rem; border-radius: 0.375rem;
            margin-top: 0.5rem; font-size: 0.8rem;
        }
        .de-buttons {
            display: flex; gap: 0.5rem; margin-top: 1rem;
        }
        .de-buttons button {
            padding: 0.5rem 1rem; border: none; border-radius: 0.375rem;
            cursor: pointer; font-size: 0.8rem; font-weight: 500;
        }
        .de-buttons .test-btn {
            background-color: #fbbf24; color: white;
        }
        .de-buttons .test-btn:hover {
            background-color: #f59e0b;
        }
        .de-buttons .reset-btn {
            background-color: #ef4444; color: white;
        }
        .de-buttons .reset-btn:hover {
            background-color: #dc2626;
        }

        @media (max-width: 768px) {
            .canvas-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ecosystem Simulation with DE Editor</h1>

        <div class="canvas-container">
            <canvas id="ecosystemCanvas"></canvas>
            <div class="legend">
                <span class="plant">Plants</span> <span class="herbivore">Herbivores</span> <span class="carnivore">Carnivores</span>
            </div>
        </div>

        <div class="canvas-row">
            <div class="canvas-container">
                <canvas id="atmosphereCanvas"></canvas>
                <div class="legend">
                    <span class="co2">CO2</span> <span class="o2">O2</span> <span class="n2">N2</span>
                </div>
            </div>
            <div class="canvas-container">
                <canvas id="pieCanvas"></canvas>
                <div class="legend" style="justify-content: center;">
                    <span style="font-weight: 600;">Atmospheric Composition</span>
                </div>
            </div>
        </div>

        <div class="canvas-row">
            <div class="canvas-container">
                <canvas id="nitrogenCanvas"></canvas>
                <div class="legend"><span class="an">Available Nitrogen</span></div>
            </div>
            <div class="canvas-container">
                <canvas id="temperatureCanvas"></canvas>
                <div class="legend"><span class="temp">Global Temperature</span></div>
            </div>
        </div>

        <div class="controls">
            <button id="startButton">Start Continuous</button> <button id="stopButton" class="secondary">Stop</button>
            <button id="tickButton">Tick</button> <button id="resetButton" class="secondary">Reset</button>
        </div>
        <div class="controls">
            <button id="addPlantButton" style="background-color: #22c55e;">+10 P</button>
            <button id="addHerbivoreButton" style="background-color: #a855f7;">+5 H</button>
            <button id="addCarnivoreButton" style="background-color: #f97316;">+2 C</button>
        </div>

        <div class="stats-container">
            <div class="stats-grid">
                <div id="plantCount">P: 0</div> <div id="herbivoreCount">H: 0</div> <div id="carnivoreCount">C: 0</div>
                <div id="co2Count">CO2: 0</div> <div id="o2Count">O2: 0</div> <div id="n2Count">N2: 0</div>
                <div id="anCount">AN: 0</div> <div id="tempCount">Temp: 0</div> <div id="timeCount">Time: 0</div>
            </div>
        </div>

        <div class="controls" style="margin-top: 1.5rem;">
            <button id="toggleDEButton">Show/Hide DE Editor</button>
            <button id="toggleParamsButton">Show/Hide Parameters</button>
        </div>

        <div id="deEditorTray" class="de-editor-tray">
            <h2>Differential Equation Editor</h2>
            <div class="de-help">
                <h3>Available Variables:</h3>
                <p><code>P</code> = Plants, <code>H</code> = Herbivores, <code>C</code> = Carnivores, <code>CO2_atm</code> = Atmospheric CO2, <code>O2_atm</code> = Atmospheric O2, <code>N2_atm</code> = Atmospheric N2, <code>AN_pool</code> = Available Nitrogen, <code>t</code> = Time</p>
                <h3>Available Functions:</h3>
                <p><code>Math.sin()</code>, <code>Math.cos()</code>, <code>Math.exp()</code>, <code>Math.log()</code>, <code>Math.pow()</code>, <code>Math.sqrt()</code>, <code>Math.abs()</code>, <code>Math.max()</code>, <code>Math.min()</code></p>
                <h3>Examples:</h3>
                <p><code>0.1 * P - 0.02 * P * H</code> (Lotka-Volterra), <code>Math.sin(t * 0.1) * 10</code> (oscillation)</p>
            </div>
            
            <div class="de-section">
                <div class="de-equation">
                    <label for="dP_dt">dP/dt (Plant growth rate):</label>
                    <textarea id="dP_dt" placeholder="Enter differential equation for Plants..."></textarea>
                    <div id="dP_dt_error" class="de-error" style="display: none;"></div>
                </div>
                
                <div class="de-equation">
                    <label for="dH_dt">dH/dt (Herbivore growth rate):</label>
                    <textarea id="dH_dt" placeholder="Enter differential equation for Herbivores..."></textarea>
                    <div id="dH_dt_error" class="de-error" style="display: none;"></div>
                </div>
                
                <div class="de-equation">
                    <label for="dC_dt">dC/dt (Carnivore growth rate):</label>
                    <textarea id="dC_dt" placeholder="Enter differential equation for Carnivores..."></textarea>
                    <div id="dC_dt_error" class="de-error" style="display: none;"></div>
                </div>
                
                <div class="de-equation">
                    <label for="dCO2_dt">dCO2_atm/dt (CO2 change rate):</label>
                    <textarea id="dCO2_dt" placeholder="Enter differential equation for CO2..."></textarea>
                    <div id="dCO2_dt_error" class="de-error" style="display: none;"></div>
                </div>
                
                <div class="de-equation">
                    <label for="dO2_dt">dO2_atm/dt (O2 change rate):</label>
                    <textarea id="dO2_dt" placeholder="Enter differential equation for O2..."></textarea>
                    <div id="dO2_dt_error" class="de-error" style="display: none;"></div>
                </div>
                
                <div class="de-equation">
                    <label for="dN2_dt">dN2_atm/dt (N2 change rate):</label>
                    <textarea id="dN2_dt" placeholder="Enter differential equation for N2..."></textarea>
                    <div id="dN2_dt_error" class="de-error" style="display: none;"></div>
                </div>
                
                <div class="de-equation">
                    <label for="dAN_dt">dAN_pool/dt (Available Nitrogen change rate):</label>
                    <textarea id="dAN_dt" placeholder="Enter differential equation for Available Nitrogen..."></textarea>
                    <div id="dAN_dt_error" class="de-error" style="display: none;"></div>
                </div>
            </div>
            
            <div class="de-buttons">
                <button class="test-btn" id="testDEButton">Test Equations</button>
                <button class="reset-btn" id="resetDEButton">Reset to Default</button>
            </div>
        </div>

        <div id="parameterTray" class="parameter-tray">
            <div class="param-section">
                <h2>Initial State</h2>
                <div class="param-grid">
                    <div class="param-item"><label for="param_initialP">Initial P</label><input type="number" id="param_initialP" step="1"></div>
                    <div class="param-item"><label for="param_initialH">Initial H</label><input type="number" id="param_initialH" step="1"></div>
                    <div class="param-item"><label for="param_initialC">Initial C</label><input type="number" id="param_initialC" step="1"></div>
                    <div class="param-item"><label for="param_initialCO2_atm">Initial CO2 (ppm)</label><input type="number" id="param_initialCO2_atm" step="1"></div>
                    <div class="param-item"><label for="param_initialO2_atm">Initial O2 (ppm)</label><input type="number" id="param_initialO2_atm" step="1000"></div>
                    <div class="param-item"><label for="param_initialN2_atm">Initial N2 (ppm)</label><input type="number" id="param_initialN2_atm" step="1000"></div>
                    <div class="param-item"><label for="param_initialAN_pool">Initial AN</label><input type="number" id="param_initialAN_pool" step="1"></div>
                    <div class="param-item"><label for="param_initialGT">Initial Temp (°C)</label><input type="number" id="param_initialGT" step="0.1"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="messageBox" class="message-box"></div>
    
    <script>
        // --- Graph Colors ---
        const PLANT_COLOR_GRAPH = '#4ade80'; const HERBIVORE_COLOR_GRAPH = '#c084fc'; const CARNIVORE_COLOR_GRAPH = '#fb923c';
        const CO2_COLOR_GRAPH = '#71717a'; const O2_COLOR_GRAPH = '#60a5fa'; const N2_COLOR_GRAPH = '#a78bfa';
        const AN_COLOR_GRAPH = '#facc15'; const TEMP_COLOR_GRAPH = '#ef4444';

        const DEFAULT_PARAMS = {
            initialP: 50, initialH: 15, initialC: 5, initialCO2_atm: 400, initialO2_atm: 210000, 
            initialN2_atm: 780000, initialAN_pool: 100, initialGT: 15.0
        };

        const DEFAULT_DES = {
            dP_dt: '0.1 * P * (1 - P / 200) - 0.02 * P * H',
            dH_dt: '0.006 * P * H - 0.01 * H * C - 0.1 * H',
            dC_dt: '0.002 * H * C - 0.05 * C',
            dCO2_dt: '0.005 * (P + H + C) - 0.1 * P',
            dO2_dt: '0.1 * P - 0.005 * (H + C)',
            dN2_dt: '0.01 * AN_pool - 0.05',
            dAN_dt: '0.05 - 0.02 * P'
        };

        const TIME_STEP = 0.1; const MAX_HISTORY_POINTS = 500;

        const ecoCanvas = document.getElementById('ecosystemCanvas'); const ecoCtx = ecoCanvas.getContext('2d');
        const atmCanvas = document.getElementById('atmosphereCanvas'); const atmCtx = atmCanvas.getContext('2d');
        const nitroCanvas = document.getElementById('nitrogenCanvas'); const nitroCtx = nitroCanvas.getContext('2d');
        const tempCanvas = document.getElementById('temperatureCanvas'); const tempCtx = tempCanvas.getContext('2d');
        const pieCanvas = document.getElementById('pieCanvas'); const pieCtx = pieCanvas.getContext('2d');
        
        let animationFrameId; let simulationRunning = false; let currentTime = 0;

        const ui = { 
            startButton: document.getElementById('startButton'), stopButton: document.getElementById('stopButton'),
            tickButton: document.getElementById('tickButton'), resetButton: document.getElementById('resetButton'),
            addPlant: document.getElementById('addPlantButton'), addHerbivore: document.getElementById('addHerbivoreButton'),
            addCarnivore: document.getElementById('addCarnivoreButton'), toggleParams: document.getElementById('toggleParamsButton'),
            toggleDE: document.getElementById('toggleDEButton'), paramTray: document.getElementById('parameterTray'),
            deTray: document.getElementById('deEditorTray'), messageBox: document.getElementById('messageBox'),
            plantCount: document.getElementById('plantCount'), herbivoreCount: document.getElementById('herbivoreCount'),
            carnivoreCount: document.getElementById('carnivoreCount'), co2Count: document.getElementById('co2Count'),
            o2Count: document.getElementById('o2Count'), n2Count: document.getElementById('n2Count'),
            anCount: document.getElementById('anCount'), tempCount: document.getElementById('tempCount'),
            timeCount: document.getElementById('timeCount'), testDE: document.getElementById('testDEButton'),
            resetDE: document.getElementById('resetDEButton')
        };

        let systemState = {}; 
        let globalTemp = 0;
        let simParams = {};
        let history = [];
        let customDEs = { ...DEFAULT_DES };
        let compiledDEs = {};
        const paramInputs = {};
        const deInputs = {};

        function setupInputs() {
            Object.keys(DEFAULT_PARAMS).forEach(key => {
                paramInputs[key] = document.getElementById(`param_${key}`);
                if (paramInputs[key]) {
                    paramInputs[key].value = DEFAULT_PARAMS[key];
                }
            });
            
            Object.keys(DEFAULT_DES).forEach(key => {
                deInputs[key] = document.getElementById(key);
                if (deInputs[key]) {
                    deInputs[key].value = DEFAULT_DES[key];
                }
            });
        }

        function showMessage(text, duration = 1500, isError = false) { 
            ui.messageBox.textContent = text;
            ui.messageBox.style.backgroundColor = isError ? '#ef4444' : '#22c55e';
            ui.messageBox.style.display = 'block';
            setTimeout(() => { ui.messageBox.style.display = 'none'; }, duration);
        }

        function compileDE(expression, varName) {
            try {
                const func = new Function('P', 'H', 'C', 'CO2_atm', 'O2_atm', 'N2_atm', 'AN_pool', 't', 'Math', 'return ' + expression);
                return func;
            } catch (error) {
                throw new Error(`Error in ${varName}: ${error.message}`);
            }
        }

        function compileDEs() {
            const errors = {};
            compiledDEs = {};
            
            // Update customDEs from textarea inputs
            Object.keys(deInputs).forEach(key => {
                if (deInputs[key]) {
                    customDEs[key] = deInputs[key].value;
                }
            });
            
            Object.keys(customDEs).forEach(key => {
                try {
                    const errorDiv = document.getElementById(key + '_error');
                    if (errorDiv) errorDiv.style.display = 'none';
                    
                    if (customDEs[key].trim() === '') {
                        compiledDEs[key] = () => 0;
                        return;
                    }
                    
                    compiledDEs[key] = compileDE(customDEs[key], key);
                } catch (error) {
                    errors[key] = error.message;
                    const errorDiv = document.getElementById(key + '_error');
                    if (errorDiv) {
                        errorDiv.textContent = error.message;
                        errorDiv.style.display = 'block';
                    }
                    compiledDEs[key] = () => 0;
                }
            });
            
            return Object.keys(errors).length === 0 ? null : errors;
        }

        function testDEs() {
            const testState = { P: 50, H: 15, C: 5, CO2_atm: 400, O2_atm: 210000, N2_atm: 780000, AN_pool: 100 };
            const testTime = 1.0;

            const errors = compileDEs();
            if (errors) {
                showMessage('DE compilation errors found. Check error messages below.', 3000, true);
                return;
            }
            
            try {
                const results = {};
                Object.keys(compiledDEs).forEach(key => {
                    const result = compiledDEs[key](
                        testState.P, testState.H, testState.C, 
                        testState.CO2_atm, testState.O2_atm, testState.N2_atm, testState.AN_pool,
                        testTime, Math
                    );
                    results[key] = result;
                });
                
                const resultStr = Object.entries(results)
                    .map(([key, value]) => `${key}: ${value.toFixed(3)}`)
                    .join(', ');
                showMessage(`DE Test Results: ${resultStr}`, 4000);
            } catch (error) {
                showMessage(`DE Test Error: ${error.message}`, 3000, true);
            }
        }

        function derivatives(currentState, t, p) {
            try {
                const results = {};
                
                results.P = compiledDEs.dP_dt ? compiledDEs.dP_dt(
                    currentState.P, currentState.H, currentState.C,
                    currentState.CO2_atm, currentState.O2_atm, currentState.N2_atm, currentState.AN_pool,
                    t, Math
                ) : 0;
                
                results.H = compiledDEs.dH_dt ? compiledDEs.dH_dt(
                    currentState.P, currentState.H, currentState.C,
                    currentState.CO2_atm, currentState.O2_atm, currentState.N2_atm, currentState.AN_pool,
                    t, Math
                ) : 0;
                
                results.C = compiledDEs.dC_dt ? compiledDEs.dC_dt(
                    currentState.P, currentState.H, currentState.C,
                    currentState.CO2_atm, currentState.O2_atm, currentState.N2_atm, currentState.AN_pool,
                    t, Math
                ) : 0;
                
                results.CO2_atm = compiledDEs.dCO2_dt ? compiledDEs.dCO2_dt(
                    currentState.P, currentState.H, currentState.C,
                    currentState.CO2_atm, currentState.O2_atm, currentState.N2_atm, currentState.AN_pool,
                    t, Math
                ) : 0;
                
                results.O2_atm = compiledDEs.dO2_dt ? compiledDEs.dO2_dt(
                    currentState.P, currentState.H, currentState.C,
                    currentState.CO2_atm, currentState.O2_atm, currentState.N2_atm, currentState.AN_pool,
                    t, Math
                ) : 0;
                
                results.N2_atm = compiledDEs.dN2_dt ? compiledDEs.dN2_dt(
                    currentState.P, currentState.H, currentState.C,
                    currentState.CO2_atm, currentState.O2_atm, currentState.N2_atm, currentState.AN_pool,
                    t, Math
                ) : 0;
                
                results.AN_pool = compiledDEs.dAN_dt ? compiledDEs.dAN_dt(
                    currentState.P, currentState.H, currentState.C,
                    currentState.CO2_atm, currentState.O2_atm, currentState.N2_atm, currentState.AN_pool,
                    t, Math
                ) : 0;
                
                return results;
            } catch (error) {
                console.error('Error in derivatives:', error);
                return { P: 0, H: 0, C: 0, CO2_atm: 0, O2_atm: 0, N2_atm: 0, AN_pool: 0 };
            }
        }

        function rk4System(y_system, dt, derivsFunc, p) { 
            const k1 = derivsFunc(y_system, currentTime, p);
            const y_k1 = {}; Object.keys(y_system).forEach(key => y_k1[key] = y_system[key] + k1[key] * dt / 2);
            const k2 = derivsFunc(y_k1, currentTime + dt / 2, p);
            const y_k2 = {}; Object.keys(y_system).forEach(key => y_k2[key] = y_system[key] + k2[key] * dt / 2);
            const k3 = derivsFunc(y_k2, currentTime + dt / 2, p);
            const y_k3 = {}; Object.keys(y_system).forEach(key => y_k3[key] = y_system[key] + k3[key] * dt);
            const k4 = derivsFunc(y_k3, currentTime + dt, p);
            const y_new_system = {};
            Object.keys(y_system).forEach(key => {
                y_new_system[key] = y_system[key] + (k1[key] + 2 * k2[key] + 2 * k3[key] + k4[key]) * dt / 6;
                if (y_new_system[key] < 0) y_new_system[key] = 0;
            });
            return y_new_system;
        }
        
        function updateSimParamsFromInputs() {
            for (const key in DEFAULT_PARAMS) {
                if (paramInputs[key]) { 
                    simParams[key] = parseFloat(paramInputs[key].value) || DEFAULT_PARAMS[key];
                }
            }
        }

        function updateGlobalTemp() {
            const baseCO2 = 280;
            const currentCO2 = systemState.CO2_atm;
            const tempChange = 3.0 * Math.log(currentCO2 / baseCO2) / Math.log(2);
            globalTemp = simParams.initialGT + tempChange;
        }

        function performTimeStep() {
            updateSimParamsFromInputs();
            systemState = rk4System(systemState, TIME_STEP, derivatives, simParams);
            currentTime += TIME_STEP;
            updateGlobalTemp();
            
            if (history.length >= MAX_HISTORY_POINTS) {
                history.shift();
            }
            history.push({
                time: currentTime,
                P: systemState.P,
                H: systemState.H,
                C: systemState.C,
                CO2_atm: systemState.CO2_atm,
                O2_atm: systemState.O2_atm,
                N2_atm: systemState.N2_atm,
                AN_pool: systemState.AN_pool,
                globalTemp: globalTemp
            });
        }

        function resizeCanvases() {
            [ecoCanvas, atmCanvas, nitroCanvas, tempCanvas, pieCanvas].forEach(canvas => {
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * window.devicePixelRatio;
                canvas.height = rect.height * window.devicePixelRatio;
                const ctx = canvas.getContext('2d');
                ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            });
        }

        function drawTimeSeriesGraph(canvas, ctx, data, variableNames, colors, title, yAxisLabel, yScale = 'linear') {
            const rect = canvas.getBoundingClientRect();
            const width = rect.width;
            const height = rect.height;
            
            ctx.clearRect(0, 0, width, height);
            
            if (data.length < 2) return;
            
            const padding = { left: 60, right: 20, top: 40, bottom: 30 };
            const graphWidth = width - padding.left - padding.right;
            const graphHeight = height - padding.top - padding.bottom;
            
            ctx.fillStyle = '#f8fafc';
            ctx.fillRect(padding.left, padding.top, graphWidth, graphHeight);
            
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (graphHeight * i) / 5;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(padding.left + graphWidth, y);
                ctx.stroke();
            }
            
            let allValues = [];
            variableNames.forEach(varName => {
                data.forEach(point => {
                    if (point[varName] !== undefined) allValues.push(point[varName]);
                });
            });
            
            if (allValues.length === 0) return;
            
            let minY = Math.min(...allValues);
            let maxY = Math.max(...allValues);
            
            if (yScale === 'log') {
                allValues = allValues.filter(v => v > 0);
                if (allValues.length === 0) return;
                minY = Math.min(...allValues);
                maxY = Math.max(...allValues);
                minY = Math.log(Math.max(minY, 0.001));
                maxY = Math.log(maxY);
            }
            
            if (minY === maxY) {
                minY -= 0.5;
                maxY += 0.5;
            }
            
            const minX = data[0].time;
            const maxX = data[data.length - 1].time;
            
            variableNames.forEach((varName, index) => {
                const color = colors[index];
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                let firstPoint = true;
                data.forEach(point => {
                    if (point[varName] === undefined || point[varName] < 0) return;
                    
                    let yValue = point[varName];
                    if (yScale === 'log') {
                        yValue = Math.log(Math.max(yValue, 0.001));
                    }
                    
                    const x = padding.left + ((point.time - minX) / (maxX - minX)) * graphWidth;
                    const y = padding.top + graphHeight - ((yValue - minY) / (maxY - minY)) * graphHeight;
                    
                    if (firstPoint) {
                        ctx.moveTo(x, y);
                        firstPoint = false;
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
            });
            
            ctx.strokeStyle = '#1f2937';
            ctx.lineWidth = 2;
            ctx.strokeRect(padding.left, padding.top, graphWidth, graphHeight);
            
            ctx.fillStyle = '#1f2937';
            ctx.font = '14px Inter';
            ctx.textAlign = 'center';
            ctx.fillText(title, width / 2, 20);
            
            ctx.font = '10px Inter';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (graphHeight * i) / 5;
                let labelValue = maxY - ((maxY - minY) * i) / 5;
                if (yScale === 'log') {
                    labelValue = Math.exp(labelValue);
                }
                let formatted = labelValue >= 1000 ? `${(labelValue/1000).toFixed(0)}k` : labelValue.toFixed(1);
                ctx.fillText(formatted, padding.left - 5, y + 3);
            }
            
            ctx.save();
            ctx.translate(15, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.font = '12px Inter';
            ctx.textAlign = 'center';
            ctx.fillText(yAxisLabel, 0, 0);
            ctx.restore();
        }

        function drawPieChart(canvas, ctx, data) {
            const rect = canvas.getBoundingClientRect();
            const width = rect.width;
            const height = rect.height;
            
            ctx.clearRect(0, 0, width, height);
            
            if (data.length === 0) return;
            
            const latest = data[data.length - 1];
            const total = latest.CO2_atm + latest.O2_atm + latest.N2_atm;
            
            if (total <= 0) return;
            
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) / 2 - 40;
            
            const slices = [
                { name: 'N₂', value: latest.N2_atm, color: N2_COLOR_GRAPH },
                { name: 'O₂', value: latest.O2_atm, color: O2_COLOR_GRAPH },
                { name: 'CO₂', value: latest.CO2_atm, color: CO2_COLOR_GRAPH }
            ];
            
            let currentAngle = -Math.PI / 2; // Start at top
            
            slices.forEach(slice => {
                const sliceAngle = (slice.value / total) * 2 * Math.PI;
                
                // Draw slice
                ctx.fillStyle = slice.color;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fill();
                
                // Draw slice border
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Draw labels
                const labelAngle = currentAngle + sliceAngle / 2;
                const labelX = centerX + Math.cos(labelAngle) * (radius * 0.7);
                const labelY = centerY + Math.sin(labelAngle) * (radius * 0.7);
                
                const percentage = ((slice.value / total) * 100).toFixed(1);
                
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 12px Inter';
                ctx.textAlign = 'center';
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 3;
                ctx.strokeText(`${slice.name}`, labelX, labelY - 5);
                ctx.fillText(`${slice.name}`, labelX, labelY - 5);
                
                ctx.font = '10px Inter';
                ctx.strokeText(`${percentage}%`, labelX, labelY + 8);
                ctx.fillText(`${percentage}%`, labelX, labelY + 8);
                
                currentAngle += sliceAngle;
            });
            
            // Draw title
            ctx.fillStyle = '#1f2937';
            ctx.font = '14px Inter';
            ctx.textAlign = 'center';
            ctx.fillText('Atmospheric Composition', centerX, 20);
            
            // Draw total concentration
            ctx.font = '10px Inter';
            ctx.fillText(`Total: ${(total/1000).toFixed(0)}k ppm`, centerX, height - 10);
        }

        function renderGraphs() {
            drawTimeSeriesGraph(
                ecoCanvas, ecoCtx, history,
                ['P', 'H', 'C'],
                [PLANT_COLOR_GRAPH, HERBIVORE_COLOR_GRAPH, CARNIVORE_COLOR_GRAPH],
                'Ecosystem Population', 'Population'
            );
            
            drawTimeSeriesGraph(
                atmCanvas, atmCtx, history,
                ['CO2_atm', 'O2_atm', 'N2_atm'],
                [CO2_COLOR_GRAPH, O2_COLOR_GRAPH, N2_COLOR_GRAPH],
                'Atmospheric Gases', 'Concentration (ppm)'
            );
            
            drawTimeSeriesGraph(
                nitroCanvas, nitroCtx, history,
                ['AN_pool'],
                [AN_COLOR_GRAPH],
                'Nitrogen Cycle', 'Available Nitrogen'
            );
            
            drawTimeSeriesGraph(
                tempCanvas, tempCtx, history,
                ['globalTemp'],
                [TEMP_COLOR_GRAPH],
                'Global Temperature', 'Temperature (°C)'
            );
            
            drawPieChart(pieCanvas, pieCtx, history);
        }

        function updateUI() {
            ui.plantCount.textContent = `P: ${Math.round(systemState.P)}`;
            ui.herbivoreCount.textContent = `H: ${Math.round(systemState.H)}`;
            ui.carnivoreCount.textContent = `C: ${Math.round(systemState.C)}`;
            ui.co2Count.textContent = `CO2: ${Math.round(systemState.CO2_atm)} ppm`;
            ui.o2Count.textContent = `O2: ${(systemState.O2_atm/1000).toFixed(0)}k ppm`;
            ui.n2Count.textContent = `N2: ${(systemState.N2_atm/1000).toFixed(0)}k ppm`;
            ui.anCount.textContent = `AN: ${Math.round(systemState.AN_pool)}`;
            ui.tempCount.textContent = `Temp: ${globalTemp.toFixed(1)}°C`;
            ui.timeCount.textContent = `Time: ${currentTime.toFixed(1)}`;
        }

        function initializeSystem() {
            updateSimParamsFromInputs();
            systemState = {
                P: simParams.initialP,
                H: simParams.initialH,
                C: simParams.initialC,
                CO2_atm: simParams.initialCO2_atm,
                O2_atm: simParams.initialO2_atm,
                N2_atm: simParams.initialN2_atm,
                AN_pool: simParams.initialAN_pool
            };
            currentTime = 0;
            history = [];
            updateGlobalTemp();
            
            history.push({
                time: currentTime,
                P: systemState.P,
                H: systemState.H,
                C: systemState.C,
                CO2_atm: systemState.CO2_atm,
                O2_atm: systemState.O2_atm,
                N2_atm: systemState.N2_atm,
                AN_pool: systemState.AN_pool,
                globalTemp: globalTemp
            });
        }

        function gameLoop() {
            if (!simulationRunning) return;
            
            performTimeStep();
            updateUI();
            renderGraphs();
            
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function startSimulation() {
            if (simulationRunning) return;
            
            const errors = compileDEs();
            if (errors) {
                showMessage('Cannot start: DE compilation errors. Check equations.', 3000, true);
                return;
            }
            
            simulationRunning = true;
            ui.startButton.disabled = true;
            ui.stopButton.disabled = false;
            gameLoop();
            showMessage('Simulation started');
        }

        function stopSimulation() {
            simulationRunning = false;
            ui.startButton.disabled = false;
            ui.stopButton.disabled = true;
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            showMessage('Simulation stopped');
        }

        function tickSimulation() {
            const errors = compileDEs();
            if (errors) {
                showMessage('Cannot tick: DE compilation errors. Check equations.', 3000, true);
                return;
            }
            
            performTimeStep();
            updateUI();
            renderGraphs();
            showMessage('Simulation advanced one step');
        }

        function resetSimulation() {
            stopSimulation();
            initializeSystem();
            updateUI();
            renderGraphs();
            showMessage('Simulation reset');
        }

        function addOrganism(type, count) {
            switch(type) {
                case 'plant': systemState.P += count; break;
                case 'herbivore': systemState.H += count; break;
                case 'carnivore': systemState.C += count; break;
            }
            updateUI();
            showMessage(`Added ${count} ${type}s`);
        }

        function resetDEsToDefault() {
            Object.keys(DEFAULT_DES).forEach(key => {
                if (deInputs[key]) {
                    deInputs[key].value = DEFAULT_DES[key];
                }
            });
            customDEs = { ...DEFAULT_DES };
            compileDEs();
            showMessage('DEs reset to default');
        }

        // Event listeners
        ui.startButton.addEventListener('click', startSimulation);
        ui.stopButton.addEventListener('click', stopSimulation);
        ui.tickButton.addEventListener('click', tickSimulation);
        ui.resetButton.addEventListener('click', resetSimulation);
        ui.addPlant.addEventListener('click', () => addOrganism('plant', 10));
        ui.addHerbivore.addEventListener('click', () => addOrganism('herbivore', 5));
        ui.addCarnivore.addEventListener('click', () => addOrganism('carnivore', 2));

        ui.toggleParams.addEventListener('click', () => {
            ui.paramTray.classList.toggle('open');
        });

        ui.toggleDE.addEventListener('click', () => {
            ui.deTray.classList.toggle('open');
        });

        ui.testDE.addEventListener('click', testDEs);
        ui.resetDE.addEventListener('click', resetDEsToDefault);

        // Initialize
        window.addEventListener('resize', () => {
            resizeCanvases();
            renderGraphs();
        });

        // Setup and start
        setupInputs();
        resizeCanvases();
        initializeSystem();
        compileDEs();
        updateUI();
        renderGraphs();
    </script>
</body>
</html>